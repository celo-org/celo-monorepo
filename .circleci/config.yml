# adapted from https://github.com/CircleCI-Public/circleci-demo-react-native
# and https://github.com/facebook/react-native/blob/master/.circleci/config.yml

version: 2.1
reference:
  workspace: &workspace ~/app
  ## Configurations
  android_config: &android_config
    working_directory: *workspace
    macos:
      xcode: '11.5.0'
    shell: /bin/bash --login -eo pipefail
    environment:
      TERM: dumb
      _JAVA_OPTIONS: '-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap'
      GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false -Dorg.gradle.configureondemand=true -Dorg.gradle.jvmargs="-Xmx4096m -XX:+HeapDumpOnOutOfMemoryError"'

defaults: &defaults
  working_directory: ~/app
  docker:
    - image: celohq/node10-gcloud:v3
  environment:
    # To avoid ENOMEM problem when running node
    NODE_OPTIONS: '--max-old-space-size=4096'

e2e-defaults: &e2e-defaults
  <<: *defaults
  docker:
    - image: celohq/circleci:geth1.9-2
  environment:
    CELO_BLOCKCHAIN_BRANCH_TO_TEST: master
general:
  artifacts:
    - 'mobile/coverage'
    - 'web/coverage'
    - 'protocol/coverage'

commands:
  yarn_install:
    steps:
      - run:
          name: Create cache checksum files
          command: |
            mkdir -p ~/.tmp/checksumfiles
            # Concatenate package.json so we can use them as a part of the cache key
            find . -maxdepth 3 -type f -name 'package.json' -not -path "*node_modules*" -print0 | sort -z | xargs -0 cat > ~/.tmp/checksumfiles/package.json
            # Concatenate patches so we can use them as a part of the cache key
            find ./patches -type f -name '*.patch' -print0 | sort -z | xargs -0 cat > ~/.tmp/checksumfiles/patches
      - restore_cache:
          name: Restore cached node_modules
          keys:
            # Using a single cache key here as we don't want to fallback on restoring node_modules produced
            # by a different yarn.lock and patches
            - node_modules-v4-{{ arch }}-{{ checksum "yarn.lock" }}-{{ checksum "~/.tmp/checksumfiles/package.json" }}-{{ checksum "~/.tmp/checksumfiles/patches" }}
      - run:
          name: Extract cached node_modules (if present)
          command: |
            if [ -e ~/.tmp/node_modules.tgz ]; then
              tar -xf ~/.tmp/node_modules.tgz
            else
              # Dependencies have changed, create beacon file used by the install and check licenses steps
              touch ~/.tmp/yarn_deps_have_changed
            fi

      - run:
          name: Install dependencies
          command: |
            if [ ! -e ~/.tmp/yarn_deps_have_changed ]; then
              # Though `yarn install` is instantaneous with up-to-date node_modules which is the case when we've restored cached node_modules,
              # there's currently a bug with the generated node_modules/.yarn-integrity file which is apparently not entirely stable
              # for a given `yarn.lock`, through different runs of `yarn install`
              # This causes the `yarn check --integrity` step to fail
              # and hence `yarn install` has to redo all the work again (taking unnecessary time, and making the current cache useless)
              # See https://github.com/yarnpkg/yarn/issues/6703
              # So here to workaround this issue, we skip the install if dependencies haven't changed
              echo "Skipping install, dependencies haven't changed"
              # We still have to run postinstall though
              yarn run postinstall
              exit 0
            fi

            # Deals with yarn install flakiness which can come due to yarnpkg.com being
            # unreliable. For example, https://circleci.com/gh/celo-org/celo-monorepo/82685
            yarn install || yarn install
      - run:
          name: Fail if someone forgot to commit "yarn.lock"
          command: |
            if [[ $(git status --porcelain) ]]; then
              git --no-pager diff
              echo "There are git differences after running yarn install"
              exit 1
            fi
      - run:
          name: Fail if generated dependency graph doesn't match committed
          command: ./scripts/ci_check_dependency_graph_changed.sh

      # Workaround save_cache not supporting globbing for the paths key
      # see note in https://circleci.com/docs/2.0/caching/#basic-example-of-dependency-caching and https://ideas.circleci.com/ideas/CCI-I-239
      - run:
          name: Create cached node_modules (if necessary)
          command: |
            if [ ! -e ~/.tmp/node_modules.tgz ]; then
              tar -c node_modules/ packages/*/node_modules/ packages/phone-number-privacy/*/node_modules/ | gzip --fast > ~/.tmp/node_modules.tgz
            fi
      - save_cache:
          name: Save cached node_modules
          key: node_modules-v4-{{ arch }}-{{ checksum "yarn.lock" }}-{{ checksum "~/.tmp/checksumfiles/package.json" }}-{{ checksum "~/.tmp/checksumfiles/patches" }}
          paths:
            - ~/.tmp/node_modules.tgz

jobs:
  install_dependencies:
    <<: *defaults
    # Source: https://circleci.com/docs/2.0/configuration-reference/#resource_class
    resource_class: medium+
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-

      - checkout

      - save_cache:
          key: source-v1-{{ .Branch }}-{{ .Revision }}
          paths:
            - '.git'

      - run:
          name: Verify setup for incremental testing
          command: |
            set -euo pipefail
            cd ~/app
            set -v
            # To get the "master" branch mapping
            git checkout master
            git checkout ${CIRCLE_BRANCH}
            # Verify that following commands work, they are later called in the incremental testing script
            # There output does not matter here, the fact that they finish successfully does.
            git rev-parse --abbrev-ref HEAD

      - attach_workspace:
          at: ~/app

      - yarn_install

      - run:
          name: Build packages
          command: |
            # separate build to avoid ENOMEM in CI :(
            yarn build --scope @celo/base
            yarn build --scope @celo/utils
            yarn build --scope @celo/protocol
            yarn build --ignore @celo/protocol --ignore docs

      - run:
          name: Check licenses
          command: |
            if [ ! -e ~/.tmp/yarn_deps_have_changed ]; then
              # Internally `yarn check-licenses` downloads dependencies into its cache again even if node_modules are up-to-date
              # which happens when we've restored our cached node_modules.
              # Making `yarn check-licenses` take ~45secs instead of ~3secs (depending on network conditions and build machine)
              # So here we skip checking when it's unnecessary
              echo "Skipping checking licenses, dependencies haven't changed"
              exit 0
            fi
            yarn check-licenses

      - persist_to_workspace:
          root: .
          paths:
            - .

  end-to-end-mobile-test-android:
    <<: *android_config
    resource_class: large
    steps:
      - checkout
      - run: cd ~/app/

      - run:
          name: set ANDROID_SDK_ROOT
          command: |
            echo 'export ANDROID_SDK_ROOT=$HOME/android-tools'  >> $BASH_ENV

      - restore_cache:
          key: android=tools-v1-{{ checksum "packages/mobile/scripts/install-android-tools.sh" }}-{{ arch }}

      - run:
          name: install android tools
          command: |
            sh packages/mobile/scripts/install-android-tools.sh
            echo 'export PATH=$ANDROID_SDK_ROOT/tools/bin:$PATH'  >> $BASH_ENV
            echo 'export PATH=$ANDROID_SDK_ROOT/tools:$PATH'  >> $BASH_ENV
            echo 'export PATH=$ANDROID_SDK_ROOT/platform-tools:$PATH'  >> $BASH_ENV
            echo 'export PATH=$ANDROID_SDK_ROOT/emulator:$PATH'  >> $BASH_ENV
            source $BASH_ENV
            sdkmanager --list

      - save_cache:
          key: android=tools-v1-{{ checksum "packages/mobile/scripts/install-android-tools.sh" }}-{{ arch }}
          paths:
            - /Users/distiller/android-tools

      - run:
          name: Create Android Virtual Device (AVD)
          command: |
            avdmanager create avd --force --name Pixel_API_29_AOSP_x86_64 \
              --package "system-images;android-29;default;x86_64" \
              --device pixel
            # Copy device configuarion, adv for some reason doesn't
            mkdir -p ~/.android/avd/Pixel_API_29_AOSP_x86_64.avd/ && cp packages/mobile/e2e/conf/avd_conf.ini ~/.android/avd/Pixel_API_29_AOSP_x86_64.avd/config.ini

      - run:
          name: Set up nodejs
          command: |
            echo `. ~/.bash_profile` # for some mreason just `source ~/.bash_profile` makes the build fail
            # install nvm
            HOMEBREW_NO_AUTO_UPDATE=1 brew install wget
            wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.0/install.sh | bash
            echo -e '\nexport NVM_DIR="$HOME/.nvm"' >> ~/.bash_profile
            echo -e '\n[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> ~/.bash_profile # add nvm to path
      - run: echo `. ~/.bash_profile`
      - run: nvm install v10.16.3 && nvm use v10.16.3
      - run:
          name: install miscellaneous
          command: |
            HOMEBREW_NO_AUTO_UPDATE=1 brew install tree coreutils

      - yarn_install

      - run:
          # This has to be run after `yarn install` since it uses js dependencies
          name: Check if the test should run
          command: ./scripts/ci_check_if_test_should_run_v2.sh @celo/mobile

      - run:
          name: Build mobile dependencies
          command: |
            set -euo pipefail
            yarn build \
              --scope @celo/mobile \
              --include-filtered-dependencies

      - restore_cache:
          key: yarn-v4-{{ arch }}-{{ .Branch }}-{{ checksum "packages/mobile/android/build.gradle" }}-{{ checksum "packages/mobile/android/settings.gradle" }}-{{ checksum "packages/mobile/android/app/build.gradle" }}-{{ checksum "packages/mobile/.env.test" }}

      # hack alert! the emulator complains about disk space and not sure how to increase it
      - run:
          name: Delete Simulators
          command: sudo rm -rf /Library/Developer/CoreSimulator/Profiles/Runtimes/

      - run:
          name: Check for emulator acceleration
          command: emulator -accel-check

      - run:
          name: Run e2e tests
          command: |
            set -euo pipefail
            cd packages/mobile
            yarn run test:e2e:android

      - store_artifacts:
          path: packages/mobile/e2e/artifacts
          destination: mobile/e2e/artifacts

      - save_cache:
          key: yarn-v4-{{ arch }}-{{ .Branch }}-{{ checksum "packages/mobile/android/build.gradle" }}-{{ checksum "packages/mobile/android/settings.gradle" }}-{{ checksum "packages/mobile/android/app/build.gradle" }}-{{ checksum "packages/mobile/.env.test" }}
          paths:
            - ~/app/packages/mobile/android/app/build/outputs/apk/
            - ~/.gradle/

  end-to-end-mobile-test-ios:
    macos:
      xcode: '11.3.1'
    working_directory: ~/app_osx
    steps:
      - checkout
      - run:
          name: Configure environment variables
          command: |
            echo 'export PATH=/usr/local/opt/node@10/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Install needed tools
          command: |
            set -euo pipefail
            export HOMEBREW_NO_AUTO_UPDATE=1
            brew install node@10
            brew tap wix/brew
            brew install applesimutils
            node -v
      # Not using a workspace here as Node and Yarn versions
      # differ between our macOS executor image and the Docker containers
      - yarn_install
      - run:
          # This has to be run after `yarn install` since it uses js dependencies
          name: Check if the test should run
          command: ./scripts/ci_check_if_test_should_run_v2.sh @celo/mobile
      - run:
          name: Build mobile dependencies
          command: |
            set -euo pipefail
            yarn build \
              --scope @celo/mobile \
              --include-filtered-dependencies
      - run:
          name: Install bundle
          command: |
            set -euo pipefail
            cd packages/mobile
            bundle install
      - run:
          name: Fail if someone forgot to commit "Gemfile.lock"
          command: |
            set -euo pipefail
            if [[ $(git status --porcelain) ]]; then
              git --no-pager diff
              echo "There are git differences after running bundle install"
              exit 1
            fi
      - restore_cache:
          name: Restore pods cache
          keys:
            # Using a single cache key here as we don't want partial cache restoration
            # i.e. when Podfile/Podfile.lock change, we want to start fresh again
            - pods-wallet-v1-{{ arch }}-{{ checksum "packages/mobile/ios/Podfile" }}-{{ checksum "packages/mobile/ios/Podfile.lock" }}
      - run:
          name: Install pods
          command: |
            set -euo pipefail
            cd packages/mobile/ios
            bundle exec pod install
      - run:
          name: Fail if someone forgot to commit "Podfile.lock"
          command: |
            set -euo pipefail
            if [[ $(git status --porcelain) ]]; then
              git --no-pager diff
              echo "There are git differences after running pod install"
              exit 1
            fi
      - save_cache:
          name: Save pods cache
          key: pods-wallet-v1-{{ arch }}-{{ checksum "packages/mobile/ios/Podfile" }}-{{ checksum "packages/mobile/ios/Podfile.lock" }}
          paths:
            - packages/mobile/ios/Pods
      - restore_cache:
          name: Restore built detox framework
          keys:
            - detox-v1-{{ arch }}-{{ checksum "yarn.lock" }}-{{ checksum "~/.tmp/checksumfiles/patches" }}
      - run:
          name: Build detox framework
          command: |
            set -euo pipefail
            cd packages/mobile
            # Make sure the detox framework is present
            yarn run detox build-framework-cache
      - save_cache:
          name: Save built detox framework
          key: detox-v1-{{ arch }}-{{ checksum "yarn.lock" }}-{{ checksum "~/.tmp/checksumfiles/patches" }}
          paths:
            - ~/Library/Detox/ios
      - run:
          name: Run e2e tests
          command: |
            set -euo pipefail
            cd packages/mobile
            yarn run test:e2e:ios
      - store_artifacts:
          path: packages/mobile/e2e/artifacts
          destination: mobile/e2e/artifacts

  lint-checks:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      # If this fails, fix it with
      # `./node_modules/.bin/prettier --config .prettierrc.js --write '**/*.+(ts|tsx|js|jsx)'`
      - run: yarn run prettify:diff
      - run: yarn run lint

  vulnerability-checks:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - run: ./scripts/ci_check_vulnerabilities.sh

  general-test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app

      - run:
          name: jest tests
          command: |
            mkdir -p test-results/jest
            yarn run lerna --ignore @celo/contractkit --ignore @celo/mobile --ignore @celo/protocol --ignore @celo/celotool --ignore @celo/celocli --ignore @celo/env-tests run test

      - store_test_results:
          path: test-results

      - store_artifacts:
          path: packages/web/coverage
          destination: web/coverage

      - run:
          name: copy
          command: |
            mkdir -p packages/web/web/coverage
            cp -r packages/web/coverage packages/web/web/
      - run:
          name: Upload to CodeCov
          command: yarn codecov -F web

  mobile-test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app

      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/mobile

      - run:
          name: Ensure translations are not missing
          command: |
            cd packages/mobile
            yarn --cwd packages/mobile test:verify-locales

      - run:
          name: jest tests
          command: |
            mkdir -p test-results/jest
            # Tests fail with https://stackoverflow.com/questions/38558989/node-js-heap-out-of-memory without this
            NODE_OPTIONS="--max-old-space-size=4096" yarn --cwd packages/mobile test:ci --runInBand
          environment:
            JEST_JUNIT_OUTPUT: test-results/jest/junit.xml

      - store_test_results:
          path: test-results

      - store_artifacts:
          path: packages/mobile/coverage
          destination: mobile/coverage

      - run:
          name: copy
          command: |
            mkdir -p packages/mobile/mobile/coverage
            cp -r packages/mobile/coverage packages/mobile/mobile/
      - run:
          name: Upload to CodeCov
          command: yarn codecov -F mobile

  protocol-test-release:
    <<: *defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/protocol
      - run:
          name: Test release against v2
          command: |
            mkdir -p ~/.ssh
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            echo "Comparing against first commit to contain version numbers"
            yarn --cwd packages/protocol test:devchain-release -b celo-core-contracts-v2.pre-audit

  protocol-test-common:
    <<: *defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/protocol
      - run:
          name: Unit tests
          command: yarn --cwd packages/protocol test common/

  protocol-test-compatibility:
    <<: *defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/protocol
      - run:
          name: Unit tests
          command: yarn --cwd packages/protocol test compatibility/

  protocol-test-governance-network:
    <<: *defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/protocol
      - run:
          name: Unit tests
          command: yarn --cwd packages/protocol test governance/network/

  protocol-test-governance-validators:
    <<: *defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/protocol
      - run:
          name: Unit tests
          command: yarn --cwd packages/protocol test governance/validators/

  protocol-test-governance-voting:
    <<: *defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/protocol
      - run:
          name: Unit tests
          command: yarn --cwd packages/protocol test governance/voting/

  protocol-test-identity:
    <<: *defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/protocol
      - run:
          name: Unit tests
          command: yarn --cwd packages/protocol test identity/

  protocol-test-stability:
    <<: *defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/protocol
      - run:
          name: Unit tests
          command: yarn --cwd packages/protocol test stability/

  # Slow and flaky compared to protocol-test which runs without coverage
  protocol-test-with-code-coverage:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/protocol
      - run:
          name: test
          command: yarn --cwd packages/protocol test:coverage
      - store_artifacts:
          path: packages/protocol/coverage
          destination: protocol/coverage
      - run:
          name: Upload to CodeCov
          command: yarn codecov -F protocol

  contractkit-test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/contractkit
      - run:
          name: Generate DevChain
          command: |
            (cd packages/contractkit && yarn test:reset)
      - run:
          name: Run Tests
          command: yarn --cwd=packages/contractkit test
      - run:
          name: Fail if someone forgot to commit contractkit docs
          command: |
            yarn --cwd=packages/contractkit docs
            if [[ $(git status packages/docs/developer-resources/contractkit --porcelain) ]]; then
              git --no-pager diff packages/docs/developer-resources/contractkit
              echo "There are git differences after generating contractkit docs"
              exit 1
            fi

  cli-test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/celocli
      - run:
          name: Generate DevChain
          command: |
            (cd packages/cli && yarn test:reset)
      - run:
          name: Run Tests
          command: yarn --cwd=packages/cli test
      - run:
          name: Fail if someone forgot to commit CLI docs
          command: |
            yarn --cwd=packages/cli docs
            if [[ $(git status packages/docs/command-line-interface --porcelain) ]]; then
              git --no-pager diff packages/docs/command-line-interface
              echo "There are git differences after generating CLI docs"
              exit 1
            fi
      - run:
          name: Verify that a new account can be created
          command: |
            yarn --cwd=packages/cli run celocli account:new

      # Won't work when cli uses git dependencies!
      # - run:
      #     name: Install and test the npm package
      #     command: |
      #       set -euo pipefail
      #       cd packages/cli
      #       yarn pack
      #       cd /tmp
      #       npm install ~/app/packages/cli/celo-celocli-*.tgz
      #       ./node_modules/.bin/celocli account:new # Small test

  typescript-test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/typescript
      - run:
          name: Install and test the npm package
          command: |
            set -euo pipefail
            cd packages/typescript
            yarn pack
            cd /tmp
            npm install ~/app/packages/typescript/*.tgz

  base-test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/base
      - run:
          name: Install and test the npm package
          command: |
            set -euo pipefail
            cd packages/base
            yarn pack
            cd /tmp
            npm install ~/app/packages/base/*.tgz

  utils-test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/utils
      - run:
          name: Install and test the npm package
          command: |
            set -euo pipefail
            cd packages/base
            yarn pack
            cd ../utils
            yarn pack
            cd /tmp
            npm install ~/app/packages/base/*.tgz
            npm install ~/app/packages/utils/*.tgz

  end-to-end-geth-transfer-test:
    <<: *e2e-defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/celotool
      - run:
          name: Run test
          no_output_timeout: 20m
          command: |
            set -e
            cd packages/celotool
            ./ci_test_transfers.sh checkout ${CELO_BLOCKCHAIN_BRANCH_TO_TEST}

  end-to-end-geth-blockchain-parameters-test:
    <<: *e2e-defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/celotool
      - run:
          name: Run test
          no_output_timeout: 20m
          command: |
            set -e
            cd packages/celotool
            ./ci_test_blockchain_parameters.sh checkout ${CELO_BLOCKCHAIN_BRANCH_TO_TEST}

  end-to-end-geth-slashing-test:
    <<: *e2e-defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/celotool
      - run:
          name: Run test
          no_output_timeout: 20m
          command: |
            set -e
            cd packages/celotool
            ./ci_test_slashing.sh checkout ${CELO_BLOCKCHAIN_BRANCH_TO_TEST}

  end-to-end-geth-governance-test:
    <<: *e2e-defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/celotool
      - run:
          name: Run test
          no_output_timeout: 20m
          command: |
            set -e
            cd packages/celotool
            ./ci_test_governance.sh checkout ${CELO_BLOCKCHAIN_BRANCH_TO_TEST}

  end-to-end-geth-replica-test:
    <<: *e2e-defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/celotool
      - run:
          name: Run test
          no_output_timeout: 20m
          command: |
            set -e
            cd packages/celotool
            ./ci_test_replicas.sh checkout ${CELO_BLOCKCHAIN_BRANCH_TO_TEST}

  end-to-end-geth-sync-test:
    <<: *e2e-defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/celotool
      - run:
          name: Run test
          command: |
            set -e
            cd packages/celotool
            ./ci_test_sync.sh checkout ${CELO_BLOCKCHAIN_BRANCH_TO_TEST}

  end-to-end-geth-validator-order-test:
    <<: *e2e-defaults
    resource_class: large
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/celotool
      - run:
          name: Run test
          command: |
            set -e
            cd packages/celotool
            ./ci_test_validator_order.sh checkout ${CELO_BLOCKCHAIN_BRANCH_TO_TEST}

  web:
    working_directory: ~/app
    docker:
      - image: celohq/node10-gcloud
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/web
      - run: mkdir ~/.ssh/ && echo -e "Host github.com\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
      - run: cd packages/web && ./circle_deploy.sh

  test-typescript-npm-package-install:
    working_directory: ~/app
    docker:
      - image: celohq/node10-gcloud
    steps:
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/typescript
      - run:
          name: Installing npm package - @celo/typescript
          command: yarn add @celo/typescript

  test-utils-npm-package-install:
    working_directory: ~/app
    docker:
      - image: celohq/node10-gcloud
    steps:
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/utils
      - run:
          name: Installing npm package - @celo/utils
          command: yarn add @celo/utils

  test-contractkit-npm-package-install:
    working_directory: ~/app
    docker:
      - image: celohq/node10-gcloud
    steps:
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/contractkit
      - run:
          name: Installing npm package - @celo/contractkit
          command: |
            # Try one more time in case the first attempt fails
            # to deal with scenarios like https://circleci.com/gh/celo-org/celo-monorepo/23329
            yarn add @celo/contractkit || yarn add @celo/contractkit

  test-celocli-npm-package-install:
    working_directory: ~/app
    docker:
      - image: celohq/node10-gcloud
    steps:
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/celocli
      - run:
          name: Installing npm package - @celo/celocli
          command: npm install @celo/celocli
      - run:
          name: Minor test of celocli
          command: ./node_modules/.bin/celocli account:new # Small test

  phone-number-privacy-test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/phone-number-privacy-signer,@celo/phone-number-privacy-combiner
      - run:
          name: Run Tests for combiner
          command: yarn --cwd=packages/phone-number-privacy/combiner test
      - run:
          name: Run Tests for signer
          command: yarn --cwd=packages/phone-number-privacy/signer test

  certora-test:
    working_directory: ~/app
    docker:
      - image: circleci/openjdk:11-jdk-node
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Check if the test should run
          command: |
            ./scripts/ci_check_if_test_should_run_v2.sh @celo/protocol
      - run:
          name: Certora dependencies
          command: |
            echo "export PATH=$PATH:~/.local/bin" >> $BASH_ENV
            sudo apt-get update || sudo apt-get update
            sudo apt-get install -y software-properties-common
            sudo apt-get install python3-pip
            pip3 install certora-cli-beta
            wget https://github.com/ethereum/solidity/releases/download/v0.5.13/solc-static-linux
            chmod +x solc-static-linux
            sudo mv solc-static-linux /usr/bin/solc
      - run:
          name: Build and run - Locked Gold
          command: |
            cd packages/protocol
            certoraRun specs/harnesses/GoldTokenHarness.sol specs/harnesses/LockedGoldHarness.sol --link LockedGoldHarness:goldToken=GoldTokenHarness --verify LockedGoldHarness:specs/lockedGold.spec --settings -assumeUnwindCond
      - run:
          name: Build and run - Accounts
          command: |
            cd packages/protocol
            certoraRun specs/harnesses/AccountsHarness.sol --verify AccountsHarness:specs/accounts.spec --settings -assumeUnwindCond

  flakey-test-summary:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Add summary of flakey tests to GitHub Checks
          command: |
            node ./packages/flake-tracker/scripts/summary.js

workflows:
  version: 2
  celo-monorepo-build:
    jobs:
      - install_dependencies
      - certora-test:
          requires:
            - install_dependencies
      - lint-checks:
          requires:
            - install_dependencies
      - vulnerability-checks:
          requires:
            - install_dependencies
      - general-test:
          requires:
            - install_dependencies
      - cli-test:
          requires:
            - install_dependencies
      - contractkit-test:
          requires:
            - install_dependencies
      - mobile-test:
          requires:
            - lint-checks
      - end-to-end-mobile-test-android
      - end-to-end-mobile-test-ios
      - protocol-test-release:
          requires:
            - lint-checks
      - protocol-test-common:
          requires:
            - lint-checks
      - protocol-test-compatibility:
          requires:
            - lint-checks
      - protocol-test-governance-network:
          requires:
            - lint-checks
      - protocol-test-governance-validators:
          requires:
            - lint-checks
      - protocol-test-governance-voting:
          requires:
            - lint-checks
      - protocol-test-identity:
          requires:
            - lint-checks
      - protocol-test-stability:
          requires:
            - lint-checks
      - typescript-test:
          requires:
            - install_dependencies
      - base-test:
          requires:
            - install_dependencies
      - utils-test:
          requires:
            - install_dependencies
      - end-to-end-geth-transfer-test:
          requires:
            - lint-checks
            - contractkit-test
      - end-to-end-geth-blockchain-parameters-test:
          requires:
            - lint-checks
            - contractkit-test
      - end-to-end-geth-slashing-test:
          requires:
            - lint-checks
            - contractkit-test
      - end-to-end-geth-governance-test:
          requires:
            - lint-checks
            - contractkit-test
      - end-to-end-geth-replica-test:
          requires:
            - lint-checks
            - contractkit-test
      - end-to-end-geth-sync-test:
          requires:
            - lint-checks
            - contractkit-test
      - end-to-end-geth-validator-order-test:
          requires:
            - lint-checks
            - contractkit-test
      - phone-number-privacy-test:
          requires:
            - lint-checks
      - flakey-test-summary:
          requires:
            - end-to-end-mobile-test-android
            - end-to-end-mobile-test-ios
            - protocol-test-common
            - protocol-test-compatibility
            - protocol-test-governance-network
            - protocol-test-governance-validators
            - protocol-test-governance-voting
            - protocol-test-identity
            - protocol-test-stability
            - mobile-test
            - end-to-end-geth-transfer-test
            - end-to-end-geth-blockchain-parameters-test
            - end-to-end-geth-slashing-test
            - end-to-end-geth-governance-test
            - end-to-end-geth-replica-test
            - end-to-end-geth-sync-test
            - end-to-end-geth-validator-order-test
            - phone-number-privacy-test
  npm-install-testing-cron-workflow:
    triggers:
      - schedule:
          # 7 PM in UTC = noon in PDT.
          # Best for test to fail during SF afternoon, so that, someone can fix it during the day time.
          cron: '0 19 * * *'
          filters:
            branches:
              only:
                - master
    jobs:
      - test-typescript-npm-package-install
      - test-utils-npm-package-install
      - test-contractkit-npm-package-install
      - test-celocli-npm-package-install
  protocol-testing-with-code-coverage-cron-workflow:
    triggers:
      - schedule:
          # 1 PM in UTC = 6 AM in PDT.
          # Best for this slow test (~3 hours) to run during SF early morning.
          cron: '0 13 * * *'
          filters:
            branches:
              only:
                - master
    jobs:
      - install_dependencies
      - lint-checks:
          requires:
            - install_dependencies
      - protocol-test-with-code-coverage:
          requires:
            - lint-checks
