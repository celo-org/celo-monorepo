# Plumo Ultralight Sync

Plumo is a zk-SNARK based system that allows mobile and resource constrained nodes on the Celo network to sync to the Celo blockchain faster and with less data. It accomplishes this by using zero-knowledge proofs, which allow the quick verification of the chain syncing computation without having to run it locally.

## Background

Celo is a mobile-first blockchain platform with a mission to enable the conditions for prosperity across the world. This means that may of Celo and the Valora wallet's first users will be in emerging markets. In these countries, while mobile phone penetration has significantly increased, data plans and device hardware still lags. This means that for average users, data is a scarce commodity and devices are underpowered in compute relative to the latest and greatest iPhone or Android devices.

If these users are to trustlessly sync and interact with a blockchain network, they'll need to run a [light client](https://www.parity.io/what-is-a-light-client/) on devices. However, traditional light clients in proof of work (PoW) blockchains need to download every block header, which grows linearly with new blocks. Over time, this becomes untenable, and even light clients [take minutes to sync](https://ethereum.stackexchange.com/questions/82568/whats-the-status-of-ethereum-light-client).

### Proof of Stake Light Clients

Celo uses a proof of stake (PoS) consensus sytem, enabling it to offer a better light client sync experience, right off the bat: 

1. First, Celo light clients only need to download epoch block headers, which contain information about the current validator set. [The validator set](./consensus/validator-set-differences.md) in Celo changes once every epoch, roughly about once per day. This means instead of downloading a block header for every block on the Celo network, they can just download one a day.

2. Second, Celo uses BLS signatures to aggregate validator signatures. Similar to Tendermint consensus, Celo's IBFT consensus mechanism requires a quorum of 2/3 or more validators to sign each block to commit it to the blockchain. Instead of having each of these signatures be separately stored on-chain, Celo uses BLS signatures which can combine them into one signature per block.

These two innovations reduce the time and data required to sync significantly, but over time, sync time continues to increase. One option is to [checkpoint](https://decentralizedthoughts.github.io/2019-09-13-dont-trust-checkpoint/) the chain ever so frequently so that clients do not need to sync from the genesis block. This certainly alleviates the challenge, but checkpointing requires getting consensus and agreement from the community, which can take time. What if there were a way to "checkpoint" cryptographically?

### Enter Plumo

This is where Plumo comes in. Plumo zk-SNARKs allow light clients to quickly verify transitions from epoch X to epoch X + Y, where Y is hundreds of epochs. This means that instead of verifying each epoch, light clients can "hop" from SNARK to SNARK until they reach the latest proof. From there, they can download the remaining epoch block headers to sync to the head of the chain.

The Plumo proofs are generated by a prover that can be run by multiple nodes across the Celo network. Proofs are then requested by light clients on the modified light client protocol. Light clients are able to verify proofs using the verification key that is included with the binary.

Using Plumo, light clients can drastically reduce the amount of data and time required to trustlessly sync with the Celo blockchain. But one more step is required for Plumo to be live on the Celo network -- the Plumo MPC setup.

## Plumo MPC Setup

In order to generate the prover and verifier keys for the Plumo SNARK circuit, it is necessary to run a multi-party computation (MPC). 

An MPC is a cryptographic mechanism for different parties to jointly perform a computation. SNARK circuits require a “trusted setup” where a shared secret is used to generate public parameters that can be used to prove and verify SNARKs. If one person ran this setup, then they could potentially prove incorrect things by exploiting a backdoor in the circuit. However, with an MPC, this setup process is split amongst tens or hundreds of contributors, and if even one of the participants is honest (keeps their inputs private), then the system will be secure.

In the case of the Plumo Ceremony, this collective computation will be a series of joint actions done by a group of participants from within the Celo community and beyond.

## How to Contribute

The Plumo Ceremony has not happened yet, and will run from late November 2020 to January 2021.

The ceremony will consist of multiple rounds of 6–10 contributors each running the Plumo setup for approximately 36 hours. While much of the activity is passive and involves simply running the computation continuously, contributors should not expect to use their machines for other intensive activies through the duration of the setup.

Contributors will also receieve a gift for the time and efforts, and be recognized for their contributions to the Celo network.

### Pre-requisites

You can run the contributor software locally or on cloud VMs, but desktop machines are preferable. The minimum machine requirements are detailed below:

#### Machine requirements:

- CPU model newer than 2016
- Minimum processor requirements:
    - 2.6GHz, 6 cores, 12 threads, OR
    - 2.3GHz, 8 cores, 16 threads, OR
    - 3.6GHz, 4 cores, 4 threads
- Operating system: Linux, macOS, Windows

## Running the Setup

<!-- The Plumo MPC setup is broken up into two phases:

TODO: explain what the two phases are -->

### Generate your address

The first step to participating is generating your Celo address.

* Download the `generate` binary corresponding to your OS from [here](https://github.com/celo-org/snark-setup-operator/releases/tag/v1.0.0-benchmarking.4).
* Run it in a command line - navigate in the command line to the relevant folder - and follow the instructions.
    * When asked to `Enter some entropy for your Plumo seed:`, you can use any source of entropy.
    * Make sure to save your passphrase - you will need it later.
* Send the address generated to kobi@clabs.co. Keep the resulting `plumo.keys` file.

### Run the Contributor software

Next you'll download the `contribute` binary and begin contributing to the Plumo setup. 

TODO: Need to explain how cLabs will coordinate the ceremony 

* After receiving confirmation from cLabs, download the `contribute` binary from [here](https://github.com/celo-org/snark-setup-operator/releases/tag/v1.0.0-benchmarking.4).
* Run it in the same directory as the `plumo.keys` file as follows:
    * Windows users:`contribute-windows --coordinator-url http://104.211.22.181`
    * macOS users:`./contribute-macos --coordinator-url http://104.211.22.181`
    * Linux users:`./contribute-linux --coordinator-url http://104.211.22.181`
* You will be asked for your passphrase - enter the same one from earlier. 
    * Follow the same process from earlier when prompted for additional entropy.
* Wait until you see 0/256 on the progress bar. This means that your contribution has started, and you are succesfully running the contributor binary.

Once this is running, you can leave the machine running -- no direct action is needed. This will run for about ~36 hours, after which the software will terminate running and you will have finished contributing to the Plumo setup!

### Troubleshooting

This section contains some common issues contributors may run into while running the setup software.

**Permissions:**
- You may need to change the permissions on both files to be able to run them. On Linux and macOS, you can run `chmod u+x generate-macos contribute-macos`.
- On Windows, you might be presented with a warning that this program is from an unsigned developer. Click "run anyway" to continue.
- On macOS, you might be shown a "permission denied" error. This is because it's a downloaded file and is by default in quarantine. You can remove it from quarantine by running `xattr -d com.apple.quarantine contribute-macos`. See here for more details: https://superuser.com/questions/526920/how-to-remove-quarantine-from-file-permissions-in-os-x. 

**Hardware:**
- TODO: What to do if machine goes to sleep (mac / PC)
- TODO: Battery runs out

**Network:**
- If you have issues uploading your contributions, it could be that you have some other processes that are consuming your bandwidth. Make sure to kill any processes such as:
    - A Nest or home camera uploading feeds
    - Torrenting / seeding any files
    - Backup services


## Additional Resources
- [Plumo Paper](https://docs.zkproof.org/pages/standards/accepted-workshop3/proposal-plumo_celolightclient.pdf)
- [Plumo Celo Improvement Proposal](https://github.com/celo-org/celo-proposals/pull/41)
- [Zero Knowledge Summit Presentation on Plumo](https://www.youtube.com/watch?v=2e0XpWgFKLg)
- [Transcript of Plumo presentation at Stanford Blockchain Conference](https://diyhpl.us/wiki/transcripts/stanford-blockchain-conference/2020/celo-ultralight-client/)