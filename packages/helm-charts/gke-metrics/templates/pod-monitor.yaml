apiVersion: monitoring.gke.io/v1alpha1
kind: PodMonitor
metadata:
  name: gke-workload-metrics
  namespace: {{ .Values.namespace }}
spec:
  namespaceSelector:
    matchNames:
    - {{ .Values.cluster }}

  # Match on all pods that have a release label, 
  # which should be the case with Helm managed k8s objects.
  # This is a dirty hack and doesn't guarantee that all pods will be caught.
  selector:
    matchExpressions:
    - key: release
      operator: Exists

  podMetricsEndpoints:
  {{- range $endpoint := $.Values.endpoints }}
  - port: {{ $endpoint.port }}
    path: {{ $endpoint.path }}
    scheme: http

    metricRelabelings:
    {{- range $relabel := $.Values.relabels }}
    - sourceLabels: {{ $relabel.sourceLabels }}
      regex: {{ $relabel.regex }}
      action: {{ $relabel.action }}
    
    {{- end }}
  {{ end }}