#!/usr/bin/env bash
set -euo pipefail

# required envs
[ -z "${PK:-}" ] && echo "Need to set the PK via env" && exit 1;
echo "Logged in as wallet: $(cast wallet address --private-key $PK)"

# optional envs
RPC_URL=${RPC_URL:-"http://127.0.0.1:8545"}

# safes
PARENT_SAFE_ADDRESS=0x4092A77bAF58fef0309452cEaCb09221e556E112
CLABS_SAFE_ADDRESS=0x9Eb44Da23433b5cAA1c87e35594D15FcEb08D34d
COUNCIL_SAFE_ADDRESS=0xC03172263409584f7860C25B6eB4985f0f6F4636
MENTO_SAFE_ADDRESS=0xD1C635987B6Aa287361d08C6461491Fa9df087f2

# clabs signers (sorted by addresses)

# cortesi
CLABS_CORTESI=0x09c0B069100F5d880a596605b94Cc9493D96e797
CLABS_CORTESI_SIG=

# piers
CLABS_PIERS=0x21e595451bDD69a85cf946f37f5A6A356C3F875D
CLABS_PIERS_SIG=

# ben
CLABS_BEN=0x48139512241D32047760E7481eBf0b6BF3390f8F
CLABS_BEN_SIG=

# javi
CLABS_JAVI=0x4D89adf3a4a71b25FB1a6D702Cf059CF5BebD02d
CLABS_JAVI_SIG=

# paul
CLABS_PAUL=0x8b4b85f78f799f8364198ffed2266d3cb3ea0dae
CLABS_PAUL_SIG=

# volpe
CLABS_VOLPE=0xE0024dCadff414fCb0AAfBB475e92Ccc367E1A84
CLABS_VOLPE_SIG=

# council signers (sorted by addresses)

# kris
COUNCIL_KRIS=0x148dfaC5dF51Ab1D7b02a3B53f1e2Da1F0A6B5Ca
COUNCIL_KRIS_SIG=

# silas
COUNCIL_SILAS=0x2BE5E223E368E8c0f404a1f3Eb4eB09f99C8FaD8
COUNCIL_SILAS_SIG=

# luca
COUNCIL_LUCA=0x6FDb3eA186981aA32DD8e7B782d95733Ca3c13A1
COUNCIL_LUCA_SIG=

# aaron
COUNCIL_AARON=0xB963047c5D875b7FE777339B1E6B61ac4df1f3e2
COUNCIL_AARON_SIG=

# tim
COUNCIL_TIM=0xd0cE4D055d04bDA69b20815A3F796019bB68c6Db
COUNCIL_TIM_SIG=

# mento signers (signers of 0xD1C635987B6Aa287361d08C6461491Fa9df087f2)

# boqdan
MENTO_BOQDAN=0xc963AE163C7d1DD4d452EA8d9684c4C24655E1E8
MENTO_BOQDAN_SIG=
# philip
MENTO_PHILIP=0xD8091Ded796FE12A4D202Ca7Ab4DA6212BadC564
MENTO_PHILIP_SIG=

# defaults
VALUE=0
OP_CALL=0
OP_DELEGATECALL=1
SAFE_TX_GAS=0
BASE_GAS=0
GAS_PRICE=0
GAS_TOKEN=0x0000000000000000000000000000000000000000
REFUND_RECEIVER=0x0000000000000000000000000000000000000000

function performUpgrade() {
  # tx data
  # @dev CALLDATA is the calldata for performing the upgrade...
  # ...it was generated using ConfigureDeploymentSafe script (celo-org/op-succinct repo)
  # ...bytes4(keccak256(abi.encodePacked("aggregate3((address,bool,bytes)[])"))) = 0x82ad56cb
  PARENT_SAFE_NONCE=24
  CLABS_SAFE_NONCE=21
  COUNCIL_SAFE_NONCE=23
  MENTO_SAFE_NONCE=5
  TARGET_ADDRESS=0xcA11bde05977b3631167028862bE2a173976CA11
  CALLDATA=0x82ad56cb0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000120000000000000000000000000fbac162162f4009bb007c6debc36b1dac10af6830000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000441e334240000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000000000000000000000000000fbac162162f4009bb007c6debc36b1dac10af68300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000004414f6b1a3000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000113f434f82ff82678ae7f69ea122791fe1f6b73e00000000000000000000000000000000000000000000000000000000

  echo "--- Parent prep ---"

  # parent hash
  PARENT_TX_HASH=$(cast call $PARENT_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $TARGET_ADDRESS $VALUE $CALLDATA $OP_DELEGATECALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $PARENT_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Parent hash: $PARENT_TX_HASH"

  echo "--- Council part ---"

  # council hash
  APPROVE_PARENT_CALLDATA=$(cast calldata 'approveHash(bytes32)' $PARENT_TX_HASH)
  COUNCIL_TX_HASH=$(cast call $COUNCIL_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $COUNCIL_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Council hash: $COUNCIL_TX_HASH"

  echo "--- Mento part ---"

  # mento hash
  APPROVE_COUNCIL_CALLDATA=$(cast calldata 'approveHash(bytes32)' $COUNCIL_TX_HASH)
  MENTO_TX_HASH=$(cast call $MENTO_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $COUNCIL_SAFE_ADDRESS $VALUE $APPROVE_COUNCIL_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $MENTO_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Mento hash: $MENTO_TX_HASH"

  # mento sig
  MENTO_SIG=0x${MENTO_BOQDAN_SIG:2}${MENTO_PHILIP_SIG:2}
  echo "Mento sig: $MENTO_SIG"

  echo "--- Mento exec ---"

  # mento exec
  cast send $MENTO_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $COUNCIL_SAFE_ADDRESS $VALUE $APPROVE_COUNCIL_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $MENTO_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "Mento executed"

  echo "--- Mento done ---"

  # council sig
  COUNCIL_SIG=0x${COUNCIL_KRIS_SIG:2}${COUNCIL_SILAS_SIG:2}${COUNCIL_LUCA_SIG:2}${COUNCIL_AARON_SIG:2}${COUNCIL_TIM_SIG:2}000000000000000000000000${MENTO_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001
  echo "Council sig: $COUNCIL_SIG"

  echo "--- Council exec ---"

  # council exec
  cast send $COUNCIL_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $COUNCIL_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "Council executed"

  echo "--- Council done ---"

  echo "--- cLabs part ---"

  # clabs hash
  CLABS_TX_HASH=$(cast call $CLABS_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $CLABS_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "cLabs hash: $CLABS_TX_HASH"

  # clabs sig
  CLABS_SIG=0x${CLABS_CORTESI_SIG:2}${CLABS_PIERS_SIG:2}${CLABS_BEN_SIG:2}${CLABS_JAVI_SIG:2}${CLABS_PAUL_SIG:2}${CLABS_VOLPE_SIG:2}
  echo "cLabs sig: $CLABS_SIG"

  echo "--- cLabs exec ---"

  # clabs exec
  cast send $CLABS_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $CLABS_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "cLabs executed"

  echo "--- cLabs done ---"

  echo "--- Parent exec ---"

  # exec parent tx
  echo "Exec upgrade"
  # signature in format where signer is nested safe (https://github.com/safe-global/safe-smart-account/blob/main/contracts/Safe.sol#L349C17-L351C94)
  PARENT_SIG=0x000000000000000000000000${CLABS_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000${COUNCIL_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000
  echo "Parent sig: $PARENT_SIG"
  cast send $PARENT_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $TARGET_ADDRESS $VALUE $CALLDATA $OP_DELEGATECALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $PARENT_SIG \
    --gas-limit 16000000 \
    --private-key $PK \
    -r $RPC_URL
  echo "Upgrade executed"

  echo "--- Parent done ---"
}

performUpgrade
