#!/usr/bin/env bash
set -euo pipefail

# required envs
[ -z "${PK:-}" ] && echo "Need to set the PK via env" && exit 1;
echo "Logged in as wallet: $(cast wallet address --private-key $PK)"

# optional envs
RPC_URL=${RPC_URL:-"http://127.0.0.1:8545"}

# safes
PARENT_SAFE_ADDRESS=0x4092A77bAF58fef0309452cEaCb09221e556E112
CLABS_SAFE_ADDRESS=0x9Eb44Da23433b5cAA1c87e35594D15FcEb08D34d
COUNCIL_SAFE_ADDRESS=0xC03172263409584f7860C25B6eB4985f0f6F4636
MENTO_SAFE_ADDRESS=0xD1C635987B6Aa287361d08C6461491Fa9df087f2

# clabs signers (sorted by addresses)

# cortesi
CLABS_CORTESI=0x09c0B069100F5d880a596605b94Cc9493D96e797
CLABS_CORTESI_SIG=0xf19588bc780707cd1929d40f94694e64a59e88da6b1c0821ed1cc2f694d604d771cd1aac0fe3765b58db73379080ad152146ead3d8b97e9d5597ca9a45a292741c

# piers
CLABS_PIERS=0x21e595451bDD69a85cf946f37f5A6A356C3F875D
CLABS_PIERS_SIG=0xdc1ff1e98c32e36b8e7063f86b54dbab321f9159bda856c6a3000f176316b62a7f75b3e9bc3622e164b91533f79fb7fe98e7a5f3adddfd5841fd2e753f6f4f491b

# ben
CLABS_BEN=0x48139512241D32047760E7481eBf0b6BF3390f8F
CLABS_BEN_SIG=0x7666366dc620bd8848b865feeca777b97e5c3edc7ab206e8cf5e4774788b365b184ab5c8e154b4c39a3f27d5c03d0189fffcfb02c5cfc9aeef0bc0f53d07105b1c

# javi
CLABS_JAVI=0x4D89adf3a4a71b25FB1a6D702Cf059CF5BebD02d
CLABS_JAVI_SIG=0xb49e9b2f20ff4b5438b3c4bfbe2689a741085986ff68c43d00c77092d572f198078486693077bafe1ca7979d4afa8a20a9ad52746bf93e965433d9182502a5ae1c

# paul
CLABS_PAUL=0x8b4b85f78f799f8364198ffed2266d3cb3ea0dae
CLABS_PAUL_SIG=0x3cb71733ba9e5657bf3c3ebb342adead6cd18c5bb0d03ecc09005930a8c5498b2785e74bbfa04499bd8dbb459dbd6c28d8b310f3a647fea2f1a26e961c3c8a201b

# volpe
CLABS_VOLPE=0xE0024dCadff414fCb0AAfBB475e92Ccc367E1A84
CLABS_VOLPE_SIG=0x3b50d07f08d6e5f87e81fa15206c72ecd4a850983a39fff601f7f0b338cc5b8714a979007827e4678a5538f316f7dd4550c824396fa728a266b105272bd97c921b

# council signers (sorted by addresses)

# kris
COUNCIL_KRIS=0x148dfaC5dF51Ab1D7b02a3B53f1e2Da1F0A6B5Ca
COUNCIL_KRIS_SIG=0x63fc87ce1788910ec5951366aba8fc7a82988f7f53aa7331b0cd73ab58a166e52fd5a8f7da618de46ef914816794ad730c3ae5dddf57b85c72c32849f5a405be1c

# silas
COUNCIL_SILAS=0x2BE5E223E368E8c0f404a1f3Eb4eB09f99C8FaD8
COUNCIL_SILAS_SIG=

# nitya
COUNCIL_NITYA=0x5f70938aA8d2fd91EE3959998E5DdaACFb6Ffb85
COUNCIL_NITYA_SIG=0xd42623fd348df733c87c346091241a487e1c721cc2e4edbf96f417ab859420ff4ea5c62c270b7773b48f04319bd3708d05e92e4b93e704286df73661e52ed42a1b

# luca
COUNCIL_LUCA=0x6FDb3eA186981aA32DD8e7B782d95733Ca3c13A1
COUNCIL_LUCA_SIG=0x9c0d88554eb8533b9a51b7d04e8ad6660d7d8d91f954ef2a3c6bebaf8cae876905a3fca4190c646f45b8475e04ce782f987766498dbb82eb711b4681c58f791c1b

# aaron
COUNCIL_AARON=0xB963047c5D875b7FE777339B1E6B61ac4df1f3e2
COUNCIL_AARON_SIG=0x60c247e54e499e249585764f74f8b3d9c12e04b6ee212cd0be44a944ef9309ec522edf4e046480f5dc90d528b34788c322537d2c15ca3b344f0cf697f0e8bc2a1b

# tim
COUNCIL_TIM=0xd0cE4D055d04bDA69b20815A3F796019bB68c6Db
COUNCIL_TIM_SIG=0xed652e4a13558b183fd76f6f729f5b619b84b4595b66e80caa987545441b7cc63b39f2087fbc77fa4240f9c35da27b02ce9e90df9160fc2f91682457181091d51c

# mento signers (signers of 0xD1C635987B6Aa287361d08C6461491Fa9df087f2)

# boqdan
MENTO_BOQDAN=0xc963AE163C7d1DD4d452EA8d9684c4C24655E1E8
MENTO_BOQDAN_SIG=0xf7bcf92e122345e922e17468464ecd1da204083a4ec7596a206f619aa91592f479ee18c6f712ac4e6e1623abc98d53e44bd05ba8a1be5190a71a664d6d320fa31b
# philip
MENTO_PHILIP=0xD8091Ded796FE12A4D202Ca7Ab4DA6212BadC564
MENTO_PHILIP_SIG=0x6ed3080412a84398da6fe5e20bb6af81d8f0a3c68d197630d872f03923db3a4034a7612d6fc855d0092df6082c6e05cfe600a3be22972430ee15ce41543f05b41c

# defaults
VALUE=0
OP_CALL=0
OP_DELEGATECALL=1
SAFE_TX_GAS=0
BASE_GAS=0
GAS_PRICE=0
GAS_TOKEN=0x0000000000000000000000000000000000000000
REFUND_RECEIVER=0x95ffac468e37ddeef407ffef18f0cc9e86d8f13b

function performUpgrade() {
  # tx data
  # @dev CALLDATA is the calldata for performing the upgrade...
  # ...it was generated using ConfigureDeploymentSafe script (celo-org/op-succinct repo)
  # ...bytes4(keccak256(abi.encodePacked("aggregate3((address,bool,bytes)[])"))) = 0x82ad56cb
  PARENT_SAFE_NONCE=24
  CLABS_SAFE_NONCE=21
  COUNCIL_SAFE_NONCE=23
  MENTO_SAFE_NONCE=5
  TARGET_ADDRESS=0xcA11bde05977b3631167028862bE2a173976CA11
  CALLDATA=0x82ad56cb0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000120000000000000000000000000fbac162162f4009bb007c6debc36b1dac10af6830000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000441e334240000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000000000000000000000000000fbac162162f4009bb007c6debc36b1dac10af68300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000004414f6b1a3000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000113f434f82ff82678ae7f69ea122791fe1f6b73e00000000000000000000000000000000000000000000000000000000

  echo "--- Parent prep ---"

  # parent hash
  PARENT_TX_HASH=$(cast call $PARENT_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $TARGET_ADDRESS $VALUE $CALLDATA $OP_DELEGATECALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $PARENT_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Parent hash: $PARENT_TX_HASH"

  echo "--- Council part ---"

  # council hash
  APPROVE_PARENT_CALLDATA=$(cast calldata 'approveHash(bytes32)' $PARENT_TX_HASH)
  COUNCIL_TX_HASH=$(cast call $COUNCIL_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $COUNCIL_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Council hash: $COUNCIL_TX_HASH"

  echo "--- Mento part ---"

  # mento hash
  APPROVE_COUNCIL_CALLDATA=$(cast calldata 'approveHash(bytes32)' $COUNCIL_TX_HASH)
  MENTO_TX_HASH=$(cast call $MENTO_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $COUNCIL_SAFE_ADDRESS $VALUE $APPROVE_COUNCIL_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $MENTO_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Mento hash: $MENTO_TX_HASH"

  # mento sig
  MENTO_SIG=0x${MENTO_BOQDAN_SIG:2}${MENTO_PHILIP_SIG:2}
  echo "Mento sig: $MENTO_SIG"

  echo "--- Mento exec ---"

  # mento exec
  cast send $MENTO_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $COUNCIL_SAFE_ADDRESS $VALUE $APPROVE_COUNCIL_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $MENTO_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "Mento executed"

  echo "--- Mento done ---"

  # council sig
  COUNCIL_SIG=0x${COUNCIL_KRIS_SIG:2}${COUNCIL_NITYA_SIG:2}${COUNCIL_LUCA_SIG:2}${COUNCIL_AARON_SIG:2}${COUNCIL_TIM_SIG:2}000000000000000000000000${MENTO_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001
  echo "Council sig: $COUNCIL_SIG"

  echo "--- Council exec ---"

  # council exec
  cast send $COUNCIL_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $COUNCIL_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "Council executed"

  echo "--- Council done ---"

  echo "--- cLabs part ---"

  # clabs hash
  CLABS_TX_HASH=$(cast call $CLABS_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $CLABS_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "cLabs hash: $CLABS_TX_HASH"

  # clabs sig
  CLABS_SIG=0x${CLABS_CORTESI_SIG:2}${CLABS_PIERS_SIG:2}${CLABS_BEN_SIG:2}${CLABS_JAVI_SIG:2}${CLABS_PAUL_SIG:2}${CLABS_VOLPE_SIG:2}
  echo "cLabs sig: $CLABS_SIG"

  echo "--- cLabs exec ---"

  # clabs exec
  cast send $CLABS_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $CLABS_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "cLabs executed"

  echo "--- cLabs done ---"

  echo "--- Parent exec ---"

  # exec parent tx
  echo "Exec upgrade"
  # signature in format where signer is nested safe (https://github.com/safe-global/safe-smart-account/blob/main/contracts/Safe.sol#L349C17-L351C94)
  PARENT_SIG=0x000000000000000000000000${CLABS_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000${COUNCIL_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000
  echo "Parent sig: $PARENT_SIG"
  cast send $PARENT_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $TARGET_ADDRESS $VALUE $CALLDATA $OP_DELEGATECALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $PARENT_SIG \
    --gas-limit 16000000 \
    --private-key $PK \
    -r $RPC_URL
  echo "Upgrade executed"

  echo "--- Parent done ---"
}

performUpgrade
