#!/usr/bin/env bash
set -euo pipefail

# get repo root
REPO_ROOT=$(git rev-parse --show-toplevel)

# required decoded files
[ ! -f "$REPO_ROOT/secrets/.env.signers.succinct" ] && echo "Need to decode .env.signers.succinct.enc first" && exit 1;

# load decoded signers
source "$REPO_ROOT/secrets/.env.signers.succinct"

# required envs
[ -z "${PK:-}" ] && echo "Need to set the PK via env" && exit 1;
echo "Logged in as wallet: $(cast wallet address --private-key $PK)"

# optional envs
RPC_URL=${RPC_URL:-"http://127.0.0.1:8545"}

# safes
PARENT_SAFE_ADDRESS=0x4092A77bAF58fef0309452cEaCb09221e556E112
CLABS_SAFE_ADDRESS=0x9Eb44Da23433b5cAA1c87e35594D15FcEb08D34d
COUNCIL_SAFE_ADDRESS=0xC03172263409584f7860C25B6eB4985f0f6F4636
GC_SAFE_ADDRESS=0xD1C635987B6Aa287361d08C6461491Fa9df087f2

# clabs signers (sorted by addresses)

# 09c
CLABS_SIGNER_09C=${CLABS_SIGNER_09C__ADDRESS}
CLABS_SIGNER_09C_SIG=${CLABS_SIGNER_09C__SIG}

# 21e
CLABS_SIGNER_21E=${CLABS_SIGNER_21E__ADDRESS}
CLABS_SIGNER_21E_SIG=${CLABS_SIGNER_21E__SIG}
# 481
CLABS_SIGNER_481=${CLABS_SIGNER_481__ADDRESS}
CLABS_SIGNER_481_SIG=${CLABS_SIGNER_481__SIG}

# 4D8
CLABS_SIGNER_4D8=${CLABS_SIGNER_4D8__ADDRESS}
CLABS_SIGNER_4D8_SIG=${CLABS_SIGNER_4D8__SIG}
# 8b4
CLABS_SIGNER_8B4=${CLABS_SIGNER_8B4__ADDRESS}
CLABS_SIGNER_8B4_SIG=${CLABS_SIGNER_8B4__SIG}

# E00
CLABS_SIGNER_E00=${CLABS_SIGNER_E00__ADDRESS}
CLABS_SIGNER_E00_SIG=${CLABS_SIGNER_E00__SIG}

# council signers (sorted by addresses)

# 148
COUNCIL_SIGNER_148=${COUNCIL_SIGNER_148__ADDRESS}
COUNCIL_SIGNER_148_SIG=${COUNCIL_SIGNER_148__SIG}

# 5f7
COUNCIL_SIGNER_5F7=${COUNCIL_SIGNER_5F7__ADDRESS}
COUNCIL_SIGNER_5F7_SIG=${COUNCIL_SIGNER_5F7__SIG}

# 6FD
COUNCIL_SIGNER_6FD=${COUNCIL_SIGNER_6FD__ADDRESS}
COUNCIL_SIGNER_6FD_SIG=${COUNCIL_SIGNER_6FD__SIG}

# b96
COUNCIL_SIGNER_B96=${COUNCIL_SIGNER_B96__ADDRESS}
COUNCIL_SIGNER_B96_SIG=${COUNCIL_SIGNER_B96__SIG}

# d0c
COUNCIL_SIGNER_D0C=${COUNCIL_SIGNER_D0C__ADDRESS}
COUNCIL_SIGNER_D0C_SIG=${COUNCIL_SIGNER_D0C__SIG}

# signers of grand child: 0xD1C

# c96
GC_D1C_SIGNER_C96=${GC_D1C_SIGNER_C96__ADDRESS}
GC_D1C_SIGNER_C96_SIG=${GC_D1C_SIGNER_C96__SIG}

# D80
GC_D1C_SIGNER_D80=${GC_D1C_SIGNER_D80__ADDRESS}
GC_D1C_SIGNER_D80_SIG=${GC_D1C_SIGNER_D80__SIG}

# defaults
VALUE=0
OP_CALL=0
OP_DELEGATECALL=1
SAFE_TX_GAS=0
BASE_GAS=0
GAS_PRICE=0
GAS_TOKEN=0x0000000000000000000000000000000000000000
REFUND_RECEIVER=0x95ffac468e37ddeef407ffef18f0cc9e86d8f13b

function performUpgrade() {
  # tx data
  # @dev CALLDATA is the calldata for performing the upgrade...
  # ...it was generated using ConfigureDeploymentSafe script (celo-org/op-succinct repo)
  # ...bytes4(keccak256(abi.encodePacked("aggregate3((address,bool,bytes)[])"))) = 0x82ad56cb
  PARENT_SAFE_NONCE=24
  CLABS_SAFE_NONCE=21
  COUNCIL_SAFE_NONCE=23
  GC_SAFE_NONCE=5
  TARGET_ADDRESS=0xcA11bde05977b3631167028862bE2a173976CA11
  CALLDATA=0x82ad56cb0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000120000000000000000000000000fbac162162f4009bb007c6debc36b1dac10af6830000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000441e334240000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000000000000000000000000000fbac162162f4009bb007c6debc36b1dac10af68300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000004414f6b1a3000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000113f434f82ff82678ae7f69ea122791fe1f6b73e00000000000000000000000000000000000000000000000000000000

  echo "--- Parent prep ---"

  # parent hash
  PARENT_TX_HASH=$(cast call $PARENT_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $TARGET_ADDRESS $VALUE $CALLDATA $OP_DELEGATECALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $PARENT_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Parent hash: $PARENT_TX_HASH"

  echo "--- Council part ---"

  # council hash
  APPROVE_PARENT_CALLDATA=$(cast calldata 'approveHash(bytes32)' $PARENT_TX_HASH)
  COUNCIL_TX_HASH=$(cast call $COUNCIL_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $COUNCIL_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Council hash: $COUNCIL_TX_HASH"

  echo "--- Grand child part ---"

  # gc hash
  APPROVE_COUNCIL_CALLDATA=$(cast calldata 'approveHash(bytes32)' $COUNCIL_TX_HASH)
  GC_TX_HASH=$(cast call $GC_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $COUNCIL_SAFE_ADDRESS $VALUE $APPROVE_COUNCIL_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $GC_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Grand child hash: $GC_TX_HASH"

  # gc sig
  GC_SIG=0x${GC_D1C_SIGNER_C96__SIG:2}${GC_D1C_SIGNER_D80__SIG:2}
  echo "Grand child sig: $GC_SIG"

  echo "--- Grand child exec ---"

  # gc exec
  cast send $GC_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $COUNCIL_SAFE_ADDRESS $VALUE $APPROVE_COUNCIL_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $GC_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "Grand child executed"

  echo "--- Grand child done ---"

  # council sig
  COUNCIL_SIG=0x${COUNCIL_SIGNER_148__SIG:2}${COUNCIL_SIGNER_5F7__SIG:2}${COUNCIL_SIGNER_6FD__SIG:2}${COUNCIL_SIGNER_B96__SIG:2}${COUNCIL_SIGNER_D0C__SIG:2}000000000000000000000000${GC_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001
  echo "Council sig: $COUNCIL_SIG"

  echo "--- Council exec ---"

  # council exec
  cast send $COUNCIL_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $COUNCIL_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "Council executed"

  echo "--- Council done ---"

  echo "--- cLabs part ---"

  # clabs hash
  CLABS_TX_HASH=$(cast call $CLABS_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $CLABS_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "cLabs hash: $CLABS_TX_HASH"

  # clabs sig
  CLABS_SIG=0x${CLABS_SIGNER_09C__SIG:2}${CLABS_SIGNER_21E__SIG:2}${CLABS_SIGNER_481__SIG:2}${CLABS_SIGNER_4D8__SIG:2}${CLABS_SIGNER_8B4__SIG:2}${CLABS_SIGNER_E00__SIG:2}
  echo "cLabs sig: $CLABS_SIG"

  echo "--- cLabs exec ---"

  # clabs exec
  cast send $CLABS_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $CLABS_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "cLabs executed"

  echo "--- cLabs done ---"

  echo "--- Parent exec ---"

  # exec parent tx
  echo "Exec upgrade"
  # signature in format where signer is nested safe (https://github.com/safe-global/safe-smart-account/blob/main/contracts/Safe.sol#L349C17-L351C94)
  PARENT_SIG=0x000000000000000000000000${CLABS_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000${COUNCIL_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000
  echo "Parent sig: $PARENT_SIG"
  cast send $PARENT_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $TARGET_ADDRESS $VALUE $CALLDATA $OP_DELEGATECALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $PARENT_SIG \
    --gas-limit 16000000 \
    --private-key $PK \
    -r $RPC_URL
  echo "Upgrade executed"

  echo "--- Parent done ---"
}

performUpgrade
