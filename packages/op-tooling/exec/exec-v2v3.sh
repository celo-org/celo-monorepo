#!/usr/bin/env bash
set -euo pipefail

# required envs
[ -z "${PK:-}" ] && echo "Need to set the PK via env" && exit 1;
echo "Logged in as wallet: $(cast wallet address --private-key $PK)"

# optional envs
RPC_URL=${RPC_URL:-"http://127.0.0.1:8545"}

# safes
PARENT_SAFE_ADDRESS=0x4092A77bAF58fef0309452cEaCb09221e556E112
CLABS_SAFE_ADDRESS=0x9Eb44Da23433b5cAA1c87e35594D15FcEb08D34d
COUNCIL_SAFE_ADDRESS=0xC03172263409584f7860C25B6eB4985f0f6F4636
MENTO_SAFE_ADDRESS=0xD1C635987B6Aa287361d08C6461491Fa9df087f2

# clabs signers (sorted by addresses)

# cortesi
CLABS_CORTESI=0x09c0B069100F5d880a596605b94Cc9493D96e797
CLABS_CORTESI_V2=0x52d19a16462993c71fe0592cad6d91243ab8596966eb96510e471445df56b3d7269194dcb7bf6a69a01861f8a3d91f4f08ab142c1c848dd1a3a4db5accc367b81b
CLABS_CORTESI_V3=0x880c604791b7f1cfa2c35911edd9bfbb08e7629034cca02f59f085ecc9de40bb7d55607ca137aa52fbdbf24ba7da8982a8be7b9caa63bc7a720c25ccfd14c0dd1b

# piers
CLABS_PIERS=0x21e595451bDD69a85cf946f37f5A6A356C3F875D
CLABS_PIERS_V2=0x08e3b29bdab1fb1e0fdad705a4bf10bca922376e48b0d52455953cb0a1cce9ea4677de47ba341f9abbc426c7fe0a438a3ffeeb1f7143cd0c16cba7a54fe16dc91b
CLABS_PIERS_V3=0x9d4e920355220d56ed7b0bb69592121fe06ddcd4050667fe6f550d727788e1e037a8ffa96b12280a059fdacae3210fae91a98060020af56fcbe1fa429302e5db1c

# ben
CLABS_BEN=0x48139512241D32047760E7481eBf0b6BF3390f8F
CLABS_BEN_V2=0xc87ff6a5f154c4bca48f0b599b1e649b9798bbdd9c2ba9c09014b634b3d04b684da605fb07be9285c459a21a9314f502ae4586ee3dec7be9d9c33581c12045321b
CLABS_BEN_V3=0x5a31e779ba668f5f14b1dd59193f74518eeb83db3b8bb2e8386b9bec7457712b5ac908108ca225328ebefac6fe540907be7b2c26fe19906acfa9ed476c70e2f31c

# javi
CLABS_JAVI=0x4D89adf3a4a71b25FB1a6D702Cf059CF5BebD02d
CLABS_JAVI_V2=0xbd3e1e39dd6c7323b625b6d8286bf780adbae1039cf6e25857ad87527fe02c280ca19467c3fda856e245871dc20140f5e7da4b185abccff716c32748196dac8d1b
CLABS_JAVI_V3=0x790c6f7b2ffd11f2a0a00dd823512485062cd04054edffb8a3f899e1488ce62d0e3c10c89a703b701d57329419d28344417d8e5d9c128733cb383d982a3efaf21c

# paul
CLABS_PAUL=0x8b4b85f78f799f8364198ffed2266d3cb3ea0dae
CLABS_PAUL_V2=0xde954b92393c6058d877de02b6b53bc65853c0c96109a3df8fc1e601a2de1fcb631b14a232992b6c447d426402023762f0d23c8d5e32b0c2eea4c9ce5655bb0c1c
CLABS_PAUL_V3=0x0fd24024a3f6a91745945204ce0496bf8956f6d89745bed26b74167419fddccf639d50e1ff4880f2951387d878c0ed58d32a860c25c54751767ecd58ae3f5aa81c

# volpe
CLABS_VOLPE=0xE0024dCadff414fCb0AAfBB475e92Ccc367E1A84
CLABS_VOLPE_V2=0xcd55ee281bbf5217333b97a4a8977d64789d2ec15819f60bdeb5f0bcb86ca5782f6935649707e350896261c8f20b6377438cd880ebba2436e1b37dbad96922981c
CLABS_VOLPE_V3=0xecf6acec3de3c328687af56403cdd6f89a4badd070cf43d12db31f7c21bca4d7553015075303b8826e80fac65e7ffe8306ea82800343981a6d061603cb6a27a01c

# council signers (sorted by addresses)

# kris
COUNCIL_KRIS=0x148dfaC5dF51Ab1D7b02a3B53f1e2Da1F0A6B5Ca
COUNCIL_KRIS_V2=0x31150dc0c25858285ace0b24f00dfc60c9fe01424303e20dc31527373d6e2a3a045525360cb705049b0a1f084632f11a6cb2a96388f585e6cd99d28eea8084171c
COUNCIL_KRIS_V3=0x16b29e708e3ea5610c482cdccf1fed9a0c2f73b09b84b93ec3f6f019ba6047ab2976e4000280f1842b0db68caa6abf1c4e7e1632de5cc3536da50cb8f3fceb681b

# silas
COUNCIL_SILAS=0x2BE5E223E368E8c0f404a1f3Eb4eB09f99C8FaD8
COUNCIL_SILAS_V2=0x36a628d77fdc5c148e95510f0c3842f030db52698a50be0685de509838e70c854c84d660982b111eceec327808198ed7f6b82ee9adc1b0271a3b88abd4c8ac471b
COUNCIL_SILAS_V3=0x56c6c30c7bf10dbc4e7bcf8ece8c89291cd62fd4b062a30f72784c3fc966ad770bb334acdcfa93ffae716095860903481bc92eab652e3919e82f061f0d8afce81c

# luca
COUNCIL_LUCA=0x6FDb3eA186981aA32DD8e7B782d95733Ca3c13A1
COUNCIL_LUCA_V2=0x636c04f796061529c7ad0c0f61ebe163da8500e9dc915b719c26cd9c57f834554d905f718e78bda616b5ab049e85bbfce810b25c47c60ca75b64727d02e78d951c
COUNCIL_LUCA_V3=0x1f26c25c5ba602b712523a29fd087afbcd7af1a2fc6dc86aff96c058f2bd3e7667d7274ef028a903ee2f26faccfd4c1d4edce8c859624a69acfbd3a4e6d046781c

# aaron
COUNCIL_AARON=0xB963047c5D875b7FE777339B1E6B61ac4df1f3e2
COUNCIL_AARON_V2=0xf2c9bd199d8f24a4540f5d5e566207767ad2913c87022b4e6237ce9c360757e53b0934d8476f92541a9b1e9c3f1d943dcc469d13c5219d2da31321d70fdbea6a1c
COUNCIL_AARON_V3=0xbc853c5e7e64d9530519ee8923ea96349a95a50a0b9f67b01d353da3d3f487d3512f4daf311829a381290794bc1b9e4c7f7187ce8f2c8d884006617f71c57bb41c

# tim
COUNCIL_TIM=0xd0cE4D055d04bDA69b20815A3F796019bB68c6Db
COUNCIL_TIM_V2=0x894371646234a90125383dc966883c377075ffc7a87255dfa5949f6401ab76236f654ddd8694ad9c37447869d65c4a25454c4272936ad3cfdca1d363fcc906501c
COUNCIL_TIM_V3=0x7e1ef7ac581c7854a6fa2a3d9078d01342bd3c5fca9d43c0a2c5559ec569a60e754fc4864e5e303007f0d6d8e353afc5b07d8d93f8987b025d1cb7dc1c3126861c

# mento signers (signers of 0xD1C635987B6Aa287361d08C6461491Fa9df087f2)

# boqdan
MENTO_BOQDAN=0xc963AE163C7d1DD4d452EA8d9684c4C24655E1E8
MENTO_BOQDAN_V2=0x6ac9ff8095047dae73ed3c1a632a6f005da7baffbaceadc4a14d711a7e4290566bd8b8d6a10e887b948f214eef9c2c1ee7da4bb90e711b29d9102351aaa3c8a71c
MENTO_BOQDAN_V3=0x240108b267f4931286879cdcfd570d6b216941d71673daafdf16e92e6843b89f219a2231c8a30d6323f1aaf96e12e3039ba6e0a8b4a9679fb902a6373bcb2f2c1b

# philip
MENTO_PHILIP=0xD8091Ded796FE12A4D202Ca7Ab4DA6212BadC564
MENTO_PHILIP_V2=0x543d392f288c7294e64ab90c8208fa44c36a98ecf23390a268f242b432ccfaa87bb0606bee451f68da63ce4faa59fc96869983585e381544f8403d7f7cea14931c
MENTO_PHILIP_V3=0x3665861df007f58c0323149cbf83e75ea132a900a7c81e30cf03aefe1eac44ff5a6533f139fcdac2ed9ed386e8cc1ed05170032709ed8b4e6253784cd9ec13331c

# defaults
VALUE=0
OP_CALL=0
OP_DELEGATECALL=1
SAFE_TX_GAS=0
BASE_GAS=0
GAS_PRICE=0
GAS_TOKEN=0x0000000000000000000000000000000000000000
REFUND_RECEIVER=0x0000000000000000000000000000000000000000

function performUpgrade() {
  # params
  VERSION=$1

  # check version
  case $VERSION in
    "v2"|"v3")
      echo "Detected supported version: $VERSION"
      ;;
    *)
      echo "Invalid version: $VERSION" && exit 1
      ;;
  esac

  # tx data
  # @dev OPCM_UPGRADE_CALLDATA is the calldata for performing the upgrade through OPCM...
# ...it was generated during last step of interaction with op-deployer (op-deployer upgrade)
# ...bytes4(keccak256(abi.encodePacked("upgrade((address,address,bytes32)[],bool)"))) = 0xa4589780
  if [ $VERSION = 'v2' ]; then
    PARENT_SAFE_NONCE=22
    CLABS_SAFE_NONCE=19
    COUNCIL_SAFE_NONCE=21
    MENTO_SAFE_NONCE=2
    OPCM_ADDRESS=0x597f110a3bee7f260b1657ab63c36d86b3740f36
    OPCM_UPGRADE_CALLDATA=0xa458978000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000089e31965d844a309231b1f17759ccaf1b7c09861000000000000000000000000783a434532ee94667979213af1711505e8bfe37403b357b30095022ecbb44ef00d1de19df39cf69ee92a60683a6be2c6f8fe6a3e
  else
    PARENT_SAFE_NONCE=23
    CLABS_SAFE_NONCE=20
    COUNCIL_SAFE_NONCE=22
    MENTO_SAFE_NONCE=3
    OPCM_ADDRESS=0x2e8cd74af534f5eeb53f889d92fd4220546a15e7
    OPCM_UPGRADE_CALLDATA=0xa458978000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000089e31965d844a309231b1f17759ccaf1b7c09861000000000000000000000000783a434532ee94667979213af1711505e8bfe374034b32d11f017711ce7122ac71d87b1c6cc73e10a0dbd957d8b27f6360acaf8f
  fi

  echo "--- Parent prep ---"

  # parent hash
  PARENT_TX_HASH=$(cast call $PARENT_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $OPCM_ADDRESS $VALUE $OPCM_UPGRADE_CALLDATA $OP_DELEGATECALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $PARENT_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Parent hash: $PARENT_TX_HASH"

  echo "--- Council part ---"

  # council hash
  APPROVE_PARENT_CALLDATA=$(cast calldata 'approveHash(bytes32)' $PARENT_TX_HASH)
  COUNCIL_TX_HASH=$(cast call $COUNCIL_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $COUNCIL_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Council hash: $COUNCIL_TX_HASH"

  echo "--- Mento part ---"

  # mento hash
  APPROVE_COUNCIL_CALLDATA=$(cast calldata 'approveHash(bytes32)' $COUNCIL_TX_HASH)
  MENTO_TX_HASH=$(cast call $MENTO_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $COUNCIL_SAFE_ADDRESS $VALUE $APPROVE_COUNCIL_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $MENTO_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Mento hash: $MENTO_TX_HASH"

  # mento sig
  if [ $VERSION = "v2" ]; then
    MENTO_SIG=0x${MENTO_BOQDAN_V2:2}${MENTO_PHILIP_V2:2}
  else
    MENTO_SIG=0x${MENTO_BOQDAN_V3:2}${MENTO_PHILIP_V3:2}
  fi
  echo "Mento sig: $MENTO_SIG"

  echo "--- Mento exec ---"

  # mento exec
  cast send $MENTO_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $COUNCIL_SAFE_ADDRESS $VALUE $APPROVE_COUNCIL_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $MENTO_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "Mento executed"

  echo "--- Mento done ---"

  # council sig
  if [ $VERSION = "v2" ]; then
    COUNCIL_SIG=0x${COUNCIL_KRIS_V2:2}${COUNCIL_SILAS_V2:2}${COUNCIL_LUCA_V2:2}${COUNCIL_AARON_V2:2}${COUNCIL_TIM_V2:2}000000000000000000000000${MENTO_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001
  else
    COUNCIL_SIG=0x${COUNCIL_KRIS_V3:2}${COUNCIL_SILAS_V3:2}${COUNCIL_LUCA_V3:2}${COUNCIL_AARON_V3:2}${COUNCIL_TIM_V3:2}000000000000000000000000${MENTO_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001
  fi
  echo "Council sig: $COUNCIL_SIG"

  echo "--- Council exec ---"

  # council exec
  cast send $COUNCIL_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $COUNCIL_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "Council executed"

  echo "--- Council done ---"

  echo "--- cLabs part ---"

  # clabs hash
  CLABS_TX_HASH=$(cast call $CLABS_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $CLABS_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "cLabs hash: $CLABS_TX_HASH"

  # clabs sig
  if [ $VERSION = "v2" ]; then
    CLABS_SIG=0x${CLABS_CORTESI_V2:2}${CLABS_PIERS_V2:2}${CLABS_BEN_V2:2}${CLABS_JAVI_V2:2}${CLABS_PAUL_V2:2}${CLABS_VOLPE_V2:2}
  else
    CLABS_SIG=0x${CLABS_CORTESI_V3:2}${CLABS_PIERS_V3:2}${CLABS_BEN_V3:2}${CLABS_JAVI_V3:2}${CLABS_PAUL_V3:2}${CLABS_VOLPE_V3:2}
  fi
  echo "cLabs sig: $CLABS_SIG"

  echo "--- cLabs exec ---"

  # clabs exec
  cast send $CLABS_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $CLABS_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "cLabs executed"

  echo "--- cLabs done ---"

  echo "--- Parent exec ---"

  # exec parent tx
  echo "Exec OPCM upgrade"
  # signature in format where signer is nested safe (https://github.com/safe-global/safe-smart-account/blob/main/contracts/Safe.sol#L349C17-L351C94)
  PARENT_SIG=0x000000000000000000000000${CLABS_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000${COUNCIL_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000
  echo "Parent sig: $PARENT_SIG"
  cast send $PARENT_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $OPCM_ADDRESS $VALUE $OPCM_UPGRADE_CALLDATA $OP_DELEGATECALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $PARENT_SIG \
    --gas-limit 16000000 \
    --private-key $PK \
    -r $RPC_URL
  echo "OPCM upgrade executed"

  echo "--- Parent done ---"
}

echo "--------- V2 ---------"
performUpgrade "v2"
echo "--------- V3 ---------"
performUpgrade "v3"
echo "--------- EOF ---------"
