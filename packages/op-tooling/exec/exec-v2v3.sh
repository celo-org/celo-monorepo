#!/usr/bin/env bash
set -euo pipefail

# required decoded files
[ ! -f ../secrets/.env.signers.v2 ] && echo "Need to decode .env.signers.v2.enc first" && exit 1;
[ ! -f ../secrets/.env.signers.v3 ] && echo "Need to decode .env.signers.v3.enc first" && exit 1;

# load decoded signers
source ../secrets/.env.signers.v2
source ../secrets/.env.signers.v3

# required envs
[ -z "${PK:-}" ] && echo "Need to set the PK via env" && exit 1;
echo "Logged in as wallet: $(cast wallet address --private-key $PK)"

# optional envs
RPC_URL=${RPC_URL:-"http://127.0.0.1:8545"}

# safes
PARENT_SAFE_ADDRESS=0x4092A77bAF58fef0309452cEaCb09221e556E112
CLABS_SAFE_ADDRESS=0x9Eb44Da23433b5cAA1c87e35594D15FcEb08D34d
COUNCIL_SAFE_ADDRESS=0xC03172263409584f7860C25B6eB4985f0f6F4636
GC_SAFE_ADDRESS=0xD1C635987B6Aa287361d08C6461491Fa9df087f2

# clabs signers (sorted by addresses)

# 09c
CLABS_SIGNER_09C=${CLABS_SIGNER_09C__ADDRESS}
CLABS_SIGNER_09C_SIG_V2=${CLABS_SIGNER_09C__SIG_V2}
CLABS_SIGNER_09C_SIG_V3=${CLABS_SIGNER_09C__SIG_V3}

# 21e
CLABS_SIGNER_21E=${CLABS_SIGNER_21E__ADDRESS}
CLABS_SIGNER_21E_SIG_V2=${CLABS_SIGNER_21E__SIG_V2}
CLABS_SIGNER_21E_SIG_V3=${CLABS_SIGNER_21E__SIG_V3}

# 481
CLABS_SIGNER_481=${CLABS_SIGNER_481__ADDRESS}
CLABS_SIGNER_481_SIG_V2=${CLABS_SIGNER_481__SIG_V2}
CLABS_SIGNER_481_SIG_V3=${CLABS_SIGNER_481__SIG_V3}

# 4D8
CLABS_SIGNER_4D8=${CLABS_SIGNER_4D8__ADDRESS}
CLABS_SIGNER_4D8_SIG_V2=${CLABS_SIGNER_4D8__SIG_V2}
CLABS_SIGNER_4D8_SIG_V3=${CLABS_SIGNER_4D8__SIG_V3}

# 8b4
CLABS_SIGNER_8B4=${CLABS_SIGNER_8B4__ADDRESS}
CLABS_SIGNER_8B4_SIG_V2=${CLABS_SIGNER_8B4__SIG_V2}
CLABS_SIGNER_8B4_SIG_V3=${CLABS_SIGNER_8B4__SIG_V3}

# E00
CLABS_SIGNER_E00=${CLABS_SIGNER_E00__ADDRESS}
CLABS_SIGNER_E00_SIG_V2=${CLABS_SIGNER_E00__SIG_V2}
CLABS_SIGNER_E00_SIG_V3=${CLABS_SIGNER_E00__SIG_V3}

# council signers (sorted by addresses)

# 148
COUNCIL_SIGNER_148=${COUNCIL_SIGNER_148__ADDRESS}
COUNCIL_SIGNER_148_SIG_V2=${COUNCIL_SIGNER_148__SIG_V2}
COUNCIL_SIGNER_148_SIG_V3=${COUNCIL_SIGNER_148__SIG_V3}

# 2BE
COUNCIL_SIGNER_2BE=${COUNCIL_SIGNER_2BE__ADDRESS}
COUNCIL_SIGNER_2BE_SIG_V2=${COUNCIL_SIGNER_2BE__SIG_V2}
COUNCIL_SIGNER_2BE_SIG_V3=${COUNCIL_SIGNER_2BE__SIG_V3}

# 6FD
COUNCIL_SIGNER_6FD=${COUNCIL_SIGNER_6FD__ADDRESS}
COUNCIL_SIGNER_6FD_SIG_V2=${COUNCIL_SIGNER_6FD__SIG_V2}
COUNCIL_SIGNER_6FD_SIG_V3=${COUNCIL_SIGNER_6FD__SIG_V3}

# b96
COUNCIL_SIGNER_B96=${COUNCIL_SIGNER_B96__ADDRESS}
COUNCIL_SIGNER_B96_SIG_V2=${COUNCIL_SIGNER_B96__SIG_V2}
COUNCIL_SIGNER_B96_SIG_V3=${COUNCIL_SIGNER_B96__SIG_V3}

# d0c
COUNCIL_SIGNER_D0C=${COUNCIL_SIGNER_D0C__ADDRESS}
COUNCIL_SIGNER_D0C_SIG_V2=${COUNCIL_SIGNER_D0C__SIG_V2}
COUNCIL_SIGNER_D0C_SIG_V3=${COUNCIL_SIGNER_D0C__SIG_V3}

# signers of grand child: 0xD1C

# c96
GC_D1C_SIGNER_C96=${GC_D1C_SIGNER_C96__ADDRESS}
GC_D1C_SIGNER_C96_SIG_V2=${GC_D1C_SIGNER_C96__SIG_V2}
GC_D1C_SIGNER_C96_SIG_V3=${GC_D1C_SIGNER_C96__SIG_V3}

# D80
GC_D1C_SIGNER_D80=${GC_D1C_SIGNER_D80__ADDRESS}
GC_D1C_SIGNER_D80_SIG_V2=${GC_D1C_SIGNER_D80__SIG_V2}
GC_D1C_SIGNER_D80_SIG_V3=${GC_D1C_SIGNER_D80__SIG_V3}

# defaults
VALUE=0
OP_CALL=0
OP_DELEGATECALL=1
SAFE_TX_GAS=0
BASE_GAS=0
GAS_PRICE=0
GAS_TOKEN=0x0000000000000000000000000000000000000000
REFUND_RECEIVER=0x0000000000000000000000000000000000000000

function performUpgrade() {
  # params
  VERSION=$1

  # check version
  case $VERSION in
    "v2"|"v3")
      echo "Detected supported version: $VERSION"
      ;;
    *)
      echo "Invalid version: $VERSION" && exit 1
      ;;
  esac

  # tx data
  # @dev OPCM_UPGRADE_CALLDATA is the calldata for performing the upgrade through OPCM...
# ...it was generated during last step of interaction with op-deployer (op-deployer upgrade)
# ...bytes4(keccak256(abi.encodePacked("upgrade((address,address,bytes32)[],bool)"))) = 0xa4589780
  if [ $VERSION = 'v2' ]; then
    PARENT_SAFE_NONCE=22
    CLABS_SAFE_NONCE=19
    COUNCIL_SAFE_NONCE=21
    GC_SAFE_NONCE=2
    OPCM_ADDRESS=0x597f110a3bee7f260b1657ab63c36d86b3740f36
    OPCM_UPGRADE_CALLDATA=0xa458978000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000089e31965d844a309231b1f17759ccaf1b7c09861000000000000000000000000783a434532ee94667979213af1711505e8bfe37403b357b30095022ecbb44ef00d1de19df39cf69ee92a60683a6be2c6f8fe6a3e
  else
    PARENT_SAFE_NONCE=23
    CLABS_SAFE_NONCE=20
    COUNCIL_SAFE_NONCE=22
    GC_SAFE_NONCE=3
    OPCM_ADDRESS=0x2e8cd74af534f5eeb53f889d92fd4220546a15e7
    OPCM_UPGRADE_CALLDATA=0xa458978000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000089e31965d844a309231b1f17759ccaf1b7c09861000000000000000000000000783a434532ee94667979213af1711505e8bfe374034b32d11f017711ce7122ac71d87b1c6cc73e10a0dbd957d8b27f6360acaf8f
  fi

  echo "--- Parent prep ---"

  # parent hash
  PARENT_TX_HASH=$(cast call $PARENT_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $OPCM_ADDRESS $VALUE $OPCM_UPGRADE_CALLDATA $OP_DELEGATECALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $PARENT_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Parent hash: $PARENT_TX_HASH"

  echo "--- Council part ---"

  # council hash
  APPROVE_PARENT_CALLDATA=$(cast calldata 'approveHash(bytes32)' $PARENT_TX_HASH)
  COUNCIL_TX_HASH=$(cast call $COUNCIL_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $COUNCIL_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Council hash: $COUNCIL_TX_HASH"

  echo "--- Grand child part ---"

  # gc hash
  APPROVE_COUNCIL_CALLDATA=$(cast calldata 'approveHash(bytes32)' $COUNCIL_TX_HASH)
  GC_TX_HASH=$(cast call $GC_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $COUNCIL_SAFE_ADDRESS $VALUE $APPROVE_COUNCIL_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $GC_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "Grand child hash: $GC_TX_HASH"

  # gc sig
  if [ $VERSION = "v2" ]; then
    GC_SIG=0x${GC_D1C_SIGNER_C96__SIG_V2:2}${GC_D1C_SIGNER_D80__SIG_V2:2}
  else
    GC_SIG=0x${GC_D1C_SIGNER_C96__SIG_V3:2}${GC_D1C_SIGNER_D80__SIG_V3:2}
  fi
  echo "Grand child sig: $GC_SIG"

  echo "--- Grand child exec ---"

  # gc exec
  cast send $GC_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $COUNCIL_SAFE_ADDRESS $VALUE $APPROVE_COUNCIL_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $GC_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "Grand child executed"

  echo "--- Grand child done ---"

  # council sig
  if [ $VERSION = "v2" ]; then
    COUNCIL_SIG=0x${COUNCIL_SIGNER_148__SIG_V2:2}${COUNCIL_SIGNER_2BE__SIG_V2:2}${COUNCIL_SIGNER_6FD__SIG_V2:2}${COUNCIL_SIGNER_B96__SIG_V2:2}${COUNCIL_SIGNER_D0C__SIG_V2:2}000000000000000000000000${GC_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001
  else
    COUNCIL_SIG=0x${COUNCIL_SIGNER_148__SIG_V3:2}${COUNCIL_SIGNER_2BE__SIG_V3:2}${COUNCIL_SIGNER_6FD__SIG_V3:2}${COUNCIL_SIGNER_B96__SIG_V3:2}${COUNCIL_SIGNER_D0C__SIG_V3:2}000000000000000000000000${GC_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001
  fi
  echo "Council sig: $COUNCIL_SIG"

  echo "--- Council exec ---"

  # council exec
  cast send $COUNCIL_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $COUNCIL_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "Council executed"

  echo "--- Council done ---"

  echo "--- cLabs part ---"

  # clabs hash
  CLABS_TX_HASH=$(cast call $CLABS_SAFE_ADDRESS \
    "getTransactionHash(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,uint256)(bytes32)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $CLABS_SAFE_NONCE \
    -r $RPC_URL
  )
  echo "cLabs hash: $CLABS_TX_HASH"

  # clabs sig
  if [ $VERSION = "v2" ]; then
    CLABS_SIG=0x${CLABS_SIGNER_09C__SIG_V2:2}${CLABS_SIGNER_21E__SIG_V2:2}${CLABS_SIGNER_481__SIG_V2:2}${CLABS_SIGNER_4D8__SIG_V2:2}${CLABS_SIGNER_8B4__SIG_V2:2}${CLABS_SIGNER_E00__SIG_V2:2}
  else
    CLABS_SIG=0x${CLABS_SIGNER_09C__SIG_V3:2}${CLABS_SIGNER_21E__SIG_V3:2}${CLABS_SIGNER_481__SIG_V3:2}${CLABS_SIGNER_4D8__SIG_V3:2}${CLABS_SIGNER_8B4__SIG_V3:2}${CLABS_SIGNER_E00__SIG_V3:2}
  fi
  echo "cLabs sig: $CLABS_SIG"

  echo "--- cLabs exec ---"

  # clabs exec
  cast send $CLABS_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $PARENT_SAFE_ADDRESS $VALUE $APPROVE_PARENT_CALLDATA $OP_CALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $CLABS_SIG \
    --private-key $PK \
    -r $RPC_URL
  echo "cLabs executed"

  echo "--- cLabs done ---"

  echo "--- Parent exec ---"

  # exec parent tx
  echo "Exec OPCM upgrade"
  # signature in format where signer is nested safe (https://github.com/safe-global/safe-smart-account/blob/main/contracts/Safe.sol#L349C17-L351C94)
  PARENT_SIG=0x000000000000000000000000${CLABS_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000${COUNCIL_SAFE_ADDRESS:2}000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000
  echo "Parent sig: $PARENT_SIG"
  cast send $PARENT_SAFE_ADDRESS \
    "execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)" \
    $OPCM_ADDRESS $VALUE $OPCM_UPGRADE_CALLDATA $OP_DELEGATECALL $SAFE_TX_GAS $BASE_GAS $GAS_PRICE $GAS_TOKEN $REFUND_RECEIVER $PARENT_SIG \
    --gas-limit 16000000 \
    --private-key $PK \
    -r $RPC_URL
  echo "OPCM upgrade executed"

  echo "--- Parent done ---"
}

echo "--------- V2 ---------"
performUpgrade "v2"
echo "--------- V3 ---------"
performUpgrade "v3"
echo "--------- EOF ---------"
