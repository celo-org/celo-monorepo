name: Publish SDK NPM packages
on:
  # DELETE `push:` to only allow for manual trigering
  push:
  workflow_dispatch:
    inputs:
      publish:
        description: 'publish the sdks?'
        required: true
        type: choice
        options:
          - Y
          - N
          - dry-run
      version:
        description: 'Version to update the sdks to. You can pick major, minor, patch, a semantic version, or nothing if you do not want to update the versions.'
        required: false
        type: string
        default: ''

jobs:
  publish-npm-sdk:
    name: Publish NPM SDK packages
    runs-on: ["self-hosted", "monorepo-npm"]
    if: contains('["aaronmgdr","@nicolasbrugneaux", "alvarof2", "jcortejoso"]', github.actor)
    permissions: # Must change the job token permissions to use JWT auth
      contents: read
      id-token: write
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v3

      # Setup Node JS with input from node version and set the registry url (defaults to npm registry)
      - name: 'Setup Node JS'
        uses: actions/setup-node@v3
        with:
          node-version: 12.22.12
          registry-url: https://registry.npmjs.org

      # Get NPM token from Akeyless
      - name: Akeyless Get Secrets
        id: get_auth_token
        uses: docker://us-west1-docker.pkg.dev/devopsre/akeyless-public/akeyless-action:latest
        with:
          api-url: https://api.gateway.akeyless.celo-networks-dev.org
          access-id: p-kf9vjzruht6l
          static-secrets: "{\"/static-secrets/devops-circle/alvaro-test/npm-test-publish\":\"NPM_TOKEN\"}"

      # CHANGE-ME!
      - name: Set WF inputs as env. vars
        run: |
          echo "publish=dry-run" >> "$GITHUB_ENV"
          echo "version=4.1.5" >> "$GITHUB_ENV"
          # echo "publish=${{ github.event.inputs.publish }}" >> "$GITHUB_ENV"
          # echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_ENV"

      - name: Temporarily remove decrypting secrets from ./package.json
        run: sed -i 's/ && yarn keys:decrypt"/"/g' package.json

      - name: Run yarn
        run: yarn
      
      - name: Run yarn build
        run: yarn build

      - name: '[POC] Set NPM org as @fernandezfalvaro in ./packages/sdk/* package.json'
        run: find ./packages/sdk -type f -name 'package.json' -exec sed -i 's/@celo/@fernandezfalvaro/g' '{}' \;

      - name: Run TS script to publish NPM packages
        run: |
          if [ ${{ env.publish }} = "dry-run" ];
          then
            echo "DRY-RUN publishing"
          elif [ ${{ env.publish }} = "Y" ];
          then
            echo "REAL publishing"
          else
            echo "`publish` env. var not set (???)"
          fi
          npm run publish-sdks-github-actions
        env:
          NODE_AUTH_TOKEN: ${{ env.NPM_TOKEN }}
