name: Run dry-run script
#on: [push]
on:
  push:
  workflow_dispatch:
    inputs:
      publish:
        description: 'publish the sdks?'
        required: true
        type: choice
        options:
          - Y
          - N
          - dry-run
      version:
        description: 'Version to update the sdks to. You can pick major, minor, patch, a semantic version, or nothing if you do not want to update the versions.'
        required: false
        type: string
        default: ''

jobs:
  dry-run:
    name: Dry run
    runs-on: ["self-hosted", "monorepo"]
    permissions: # Must change the job token permissions to use JWT auth
      contents: read
      id-token: write
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v3

      # Setup Node JS with input from node version and set the registry url (defaults to npm registry)
      - name: 'Setup Node JS'
        uses: actions/setup-node@v3
        with:
          node-version: 12.22.12
          registry-url: https://registry.npmjs.org

      - name: Akeyless Get Secrets
        id: get_auth_token
        uses: docker://us-west1-docker.pkg.dev/devopsre/akeyless-public/akeyless-action:latest
        with:
          api-url: https://api.gateway.akeyless.celo-networks-dev.org
          access-id: p-kf9vjzruht6l
          static-secrets: "{\"/static-secrets/devops-circle/alvaro-test/npm-test-publish\":\"NPM_TOKEN\"}"

      - run: |
          echo "publish=Y" >> "$GITHUB_ENV"
          echo "version=4.1.5" >> "$GITHUB_ENV"
          # echo "publish=${{ github.event.inputs.publish }}" >> "$GITHUB_ENV"
          # echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_ENV"

      - run: sed -i 's/ && yarn keys:decrypt"/"/g' package.json

      - run: yarn
      - run: yarn build

      - run: find ./packages/sdk -type f -name 'package.json' -exec sed -i 's/@celo/@fernandezfalvaro/g' '{}' \;

      - run: |
          npm run deploy-sdks-dry-run
        env:
          NODE_AUTH_TOKEN: ${{ env.NPM_TOKEN }}
